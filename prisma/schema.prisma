generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id           String      @id @default(uuid())
  email        String      @unique
  passwordHash String
  username     String      @unique
  createdAt    DateTime    @default(now())
  lastLoginAt  DateTime?
  characters   Character[]

  @@map("accounts")
}

model Character {
  id                String   @id @default(uuid())
  accountId         String
  name              String
  level             Int      @default(1)
  experience        Int      @default(0)
  abilityPoints     Int      @default(0)
  supernaturalType  String?
  supernaturalData  Json?
  strength          Int      @default(10)
  vitality          Int      @default(10)
  dexterity         Int      @default(10)
  agility           Int      @default(10)
  intelligence      Int      @default(10)
  wisdom            Int      @default(10)
  maxHp             Int      @default(200)
  maxStamina        Int      @default(100)
  maxMana           Int      @default(100)
  attackRating      Float    @default(30)
  defenseRating     Float    @default(5)
  magicAttack       Float    @default(30)
  magicDefense      Float    @default(5)
  currentHp         Int      @default(200)
  currentStamina    Int      @default(100)
  currentMana       Int      @default(100)
  isAlive           Boolean  @default(true)
  zoneId            String
  positionX         Float
  positionY         Float
  positionZ         Float
  heading           Float    @default(0)
  rotation          Float    @default(0)
  unlockedFeats     Json     @default("[]")
  unlockedAbilities Json     @default("[]")
  activeLoadout     Json     @default("[]")
  passiveLoadout    Json     @default("[]")
  specialLoadout    Json     @default("[]")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  lastSeenAt        DateTime @default(now())

  // Corruption system
  corruption              Float     @default(0) // 0-100 scale
  lastCorruptionTickAt    DateTime  @default(now())
  isolationSeconds        Int       @default(0) // Time away from community
  communitySeconds        Int       @default(0) // Time in community (resets isolation)
  wealthScoreCached       Int       @default(0) // Server-computed wealth value
  wealthScoreCachedAt     DateTime  @default(now())
  contributionPoints      Int       @default(0) // Earned via community actions
  contributionBuffExpires DateTime? // When wealth_gain_multiplier buff expires

  account            Account             @relation(fields: [accountId], references: [id], onDelete: Cascade)
  zone               Zone                @relation(fields: [zoneId], references: [id])
  inventory          InventoryItem[]
  corruptionEvents   CorruptionEvent[]
  factionReputations FactionReputation[]
  questProgress      QuestProgress[]

  // Market system
  wallet          CharacterWallet?
  tradeReputation TradeReputation?
  marketOrders    MarketOrder[]

  @@index([accountId])
  @@index([zoneId])
  @@map("characters")
}

model Zone {
  id               String   @id @default(uuid())
  name             String
  description      String?
  worldX           Int
  worldY           Int
  sizeX            Float
  sizeY            Float
  sizeZ            Float
  terrainType      String
  weatherEnabled   Boolean  @default(true)
  timeOfDayEnabled Boolean  @default(true)
  contentRating    String   @default("T")
  navmeshData      Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Corruption system - zone environmental corruption
  corruptionTag String  @default("WILDS") // WILDS, RUINS_CITY_EDGE, OLD_CITY_CORE, MOUNTAIN_HOLD, DEEP_LAB, WARD_ZONE
  isWarded      Boolean @default(false) // Warded zones actively reduce corruption

  characters Character[]

  @@unique([worldX, worldY])
  @@map("zones")
}

model ItemTemplate {
  id           String            @id @default(uuid())
  name         String
  description  String?
  itemType     String
  properties   Json
  iconUrl      String?
  modelUrl     String?
  value        Int               @default(0)
  stackable    Boolean           @default(false)
  maxStackSize Int               @default(1)
  createdAt    DateTime          @default(now())
  instances    InventoryItem[]
  tags         ItemTemplateTag[]

  @@map("item_templates")
}

model InventoryItem {
  id             String       @id @default(uuid())
  characterId    String
  itemTemplateId String
  quantity       Int          @default(1)
  durability     Float?
  customData     Json?
  equipped       Boolean      @default(false)
  equipSlot      String?
  character      Character    @relation(fields: [characterId], references: [id], onDelete: Cascade)
  template       ItemTemplate @relation(fields: [itemTemplateId], references: [id])

  @@index([characterId])
  @@map("inventory_items")
}

model ItemTag {
  id        String            @id @default(uuid())
  name      String            @unique
  createdAt DateTime          @default(now())
  templates ItemTemplateTag[]

  @@map("item_tags")
}

model ItemTemplateTag {
  itemTemplateId String
  tagId          String
  itemTemplate   ItemTemplate @relation(fields: [itemTemplateId], references: [id], onDelete: Cascade)
  tag            ItemTag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([itemTemplateId, tagId])
  @@index([tagId])
  @@map("item_template_tags")
}

model Companion {
  id                  String  @id @default(uuid())
  name                String
  tag                 String?
  description         String?
  personalityType     String
  memoryData          Json
  level               Int     @default(1)
  stats               Json
  currentHealth       Int
  maxHealth           Int
  isAlive             Boolean @default(true)
  zoneId              String
  positionX           Float
  positionY           Float
  positionZ           Float
  llmProvider         String  @default("anthropic")
  llmModel            String  @default("claude-3-5-sonnet-20241022")
  systemPrompt        String?
  possessedAirlockId  String?
  conversationHistory Json    @default("[]")

  // NPC personality & capabilities (for Airlock's LLM context)
  traits        String[]
  goals         String[]
  relationships Json     @default("{}")
  abilityIds    String[]

  // Quests this NPC can give
  questIds String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Airlock's long-term memory for this NPC
  memory CompanionMemory?

  @@index([tag])
  @@index([possessedAirlockId])
  @@map("companions")
}

model CompanionMemory {
  id          String    @id @default(uuid())
  companionId String    @unique
  companion   Companion @relation(fields: [companionId], references: [id], onDelete: Cascade)

  // Raw interaction log (pruned to ~500 most recent)
  interactions Json @default("[]")

  // Consolidated disposition summary {characterId: {feeling, reason, strength, lastInteractionAt}}
  dispositionSummary Json @default("{}")

  // Semantic facts Airlock has inferred ("Player X is strong", "Player Y betrayed me")
  knownFacts String[] @default([])

  // Track sync status between Redis and Postgres
  syncedToRedisAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companionId])
  @@map("companion_memories")
}

model Ability {
  id          String   @id
  name        String
  description String?
  data        Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("abilities")
}

model Faction {
  id              String              @id @default(uuid())
  name            String              @unique
  description     String?
  factionType     String
  parentFactionId String?
  controlledZones String[]
  createdAt       DateTime            @default(now())
  reputations     FactionReputation[]
  parentFaction   Faction?            @relation("FactionHierarchy", fields: [parentFactionId], references: [id])
  childFactions   Faction[]           @relation("FactionHierarchy")

  @@map("factions")
}

model FactionReputation {
  id          String    @id @default(uuid())
  characterId String
  factionId   String
  reputation  Int       @default(0)
  standing    String
  character   Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  faction     Faction   @relation(fields: [factionId], references: [id], onDelete: Cascade)

  @@unique([characterId, factionId])
  @@index([characterId])
  @@map("faction_reputations")
}

model Quest {
  id              String  @id @default(uuid())
  title           String
  description     String
  questType       String // "sidequest", "bounty", "investigation", "delivery", etc.
  requiredLevel   Int     @default(1)
  requiredFaction String?

  // NPC who gives this quest (can be multiple NPCs)
  giversNpcIds String[]

  // Quest objectives: [{ type: "kill", target: "rat", count: 5 }, ...]
  objectives Json

  // Quest rewards: { xp: 500, money: 100, items: ["item1", "item2"] }
  rewards Json

  // Dialogue stages: { accepted: "Go forth...", completed: "Well done!", inProgress: "Finding progress?" }
  dialogueStages Json

  prerequisiteQuestIds String[]
  followupQuestIds     String[]
  createdAt            DateTime        @default(now())
  progress             QuestProgress[]

  @@map("quests")
}

model QuestProgress {
  id                String    @id @default(uuid())
  characterId       String
  questId           String
  status            String    @default("active")
  objectiveProgress Json
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  character         Character @relation(fields: [characterId], references: [id], onDelete: Cascade)
  quest             Quest     @relation(fields: [questId], references: [id], onDelete: Cascade)

  @@unique([characterId, questId])
  @@index([characterId])
  @@map("quest_progress")
}

model CombatLog {
  id           String   @id @default(uuid())
  combatId     String
  participants Json
  actions      Json
  outcome      String
  startedAt    DateTime @default(now())
  endedAt      DateTime
  duration     Int

  @@index([combatId])
  @@map("combat_logs")
}

model CorruptionEvent {
  id               String   @id @default(uuid())
  characterId      String
  eventType        String // ZONE_TICK, ISOLATION_TICK, WEALTH_TICK, FORBIDDEN_ACTION, CONTRIBUTION, CLEANSING, etc.
  delta            Float // Amount corruption changed (positive = gain, negative = reduction)
  corruptionBefore Float
  corruptionAfter  Float
  reason           String? // Human-readable reason: "30 min in DEEP_LAB", "Looted community store", etc.
  metadata         Json? // Additional context: { zoneId, zoneTag, isolationMinutes, wealthScore, etc. }
  createdAt        DateTime @default(now())

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@index([characterId])
  @@index([eventType])
  @@index([createdAt])
  @@map("corruption_events")
}

// ============================================================================
// MARKET SYSTEM
// ============================================================================

model CharacterWallet {
  id          String   @id @default(uuid())
  characterId String   @unique
  gold        Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("character_wallets")
}

model Region {
  id             String   @id @default(uuid())
  name           String   @unique
  biomeType      String // FOREST, MOUNTAIN, RIVERLANDS, COASTAL, URBAN, etc.
  mamMultipliers Json     @default("{}") // Material Availability Multipliers: {"WOOD": 2.0, "CLAY": 1.0, "STONE": 0.6}
  zoneIds        String[] // Zone IDs that belong to this region
  baseTaxRate    Float    @default(0.05) // 5% base regional tax
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orders MarketOrder[]
  stalls MarketStall[]

  @@map("regions")
}

model MarketStall {
  id        String   @id @default(uuid())
  ownerId   String // Character ID who owns the stall
  regionId  String
  plotId    String? // Future: links to plot system
  name      String
  stallType String   @default("GENERAL") // GENERAL, WEAPONS, ARMOR, MATERIALS, etc.
  zoneId    String?
  positionX Float?
  positionY Float?
  positionZ Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  region Region        @relation(fields: [regionId], references: [id])
  orders MarketOrder[]

  @@index([ownerId])
  @@index([regionId])
  @@map("market_stalls")
}

model WorldMarketSlot {
  id          String   @id @default(uuid())
  characterId String
  slotIndex   Int // 0, 1, 2 are free; 3+ require unlock
  unlockCost  Int      @default(0) // Gold paid to unlock this slot
  unlockedAt  DateTime @default(now())

  @@unique([characterId, slotIndex])
  @@index([characterId])
  @@map("world_market_slots")
}

model MarketOrder {
  id              String    @id @default(uuid())
  sellerId        String // Character ID
  stallId         String? // Optional stall association
  regionId        String // Region where order is listed
  orderType       String // SELL or BUY
  orderScope      String // REGIONAL or WORLD
  itemTemplateId  String // What's being sold/bought
  inventoryItemId String? // Specific item instance (for unique/modified items)
  quantity        Int       @default(1)
  filledQuantity  Int       @default(0)
  pricePerUnit    Int
  listingFee      Int       @default(0)
  worldSlotIndex  Int? // For world orders: which slot is used
  corruptionTag   String? // Item corruption state: CLEAN, STAINED, WARPED, POSSESSED
  flavorText      String? // Corruption flavor: "This blade whispers..."
  status          String    @default("ACTIVE") // ACTIVE, PENDING_DELIVERY, COMPLETED, CANCELLED, EXPIRED
  createdAt       DateTime  @default(now())
  expiresAt       DateTime?
  completedAt     DateTime?

  seller   Character    @relation(fields: [sellerId], references: [id])
  region   Region       @relation(fields: [regionId], references: [id])
  stall    MarketStall? @relation(fields: [stallId], references: [id])
  shipment Shipment?

  @@index([sellerId])
  @@index([regionId, status])
  @@index([itemTemplateId])
  @@index([orderScope, status])
  @@map("market_orders")
}

model Shipment {
  id              String    @id @default(uuid())
  orderId         String    @unique
  sellerId        String
  buyerId         String
  originRegionId  String
  destRegionId    String
  courierType     String    @default("NPC") // NPC, PLAYER, SELLER
  courierId       String? // Character ID if player courier
  insuranceTier   String    @default("NONE") // NONE, STANDARD, EXPRESS
  insuranceCost   Int       @default(0)
  estimatedEta    DateTime
  departedAt      DateTime?
  deliveredAt     DateTime?
  status          String    @default("PENDING") // PENDING, IN_TRANSIT, DELIVERED, FAILED
  currentZoneId   String? // For tracking player courier position
  progressPercent Float     @default(0)
  createdAt       DateTime  @default(now())

  order    MarketOrder      @relation(fields: [orderId], references: [id])
  contract CourierContract?

  @@index([courierId])
  @@index([status])
  @@map("shipments")
}

model CourierContract {
  id               String    @id @default(uuid())
  shipmentId       String    @unique
  courierId        String? // Player who accepted the contract
  fee              Int // Payment for delivery
  bond             Int // Held until completion (anti-griefing)
  status           String    @default("OFFERED") // OFFERED, ACCEPTED, COMPLETED, FAILED, EXPIRED
  acceptDeadline   DateTime
  deliveryDeadline DateTime
  acceptedAt       DateTime?
  completedAt      DateTime?
  createdAt        DateTime  @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id])

  @@index([courierId])
  @@index([status])
  @@map("courier_contracts")
}

model TradeReputation {
  id                  String   @id @default(uuid())
  characterId         String   @unique
  salesCompleted      Int      @default(0)
  salesVolume         Int      @default(0) // Total gold earned from sales
  purchasesCompleted  Int      @default(0)
  purchasesVolume     Int      @default(0) // Total gold spent
  deliveriesCompleted Int      @default(0)
  deliveriesFailed    Int      @default(0)
  buyerRating         Float    @default(5.0) // 1-5 stars
  sellerRating        Float    @default(5.0)
  courierRating       Float    @default(5.0)
  trustedTrader       Boolean  @default(false) // Unlocks reduced fees
  masterCourier       Boolean  @default(false) // Unlocks priority contracts
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id], onDelete: Cascade)

  @@map("trade_reputations")
}

model MarketTransaction {
  id              String   @id @default(uuid())
  transactionType String // ORDER_CREATED, ORDER_FILLED, ORDER_CANCELLED, SHIPMENT_STARTED, SHIPMENT_DELIVERED, SLOT_UNLOCKED
  orderId         String?
  shipmentId      String?
  sellerId        String?
  buyerId         String?
  courierId       String?
  itemTemplateId  String?
  quantity        Int      @default(0)
  itemValue       Int      @default(0)
  feesPaid        Int      @default(0) // Listing + transaction fees
  taxesPaid       Int      @default(0) // Regional taxes
  metadata        Json? // Additional context
  createdAt       DateTime @default(now())

  @@index([sellerId])
  @@index([buyerId])
  @@index([transactionType])
  @@index([createdAt])
  @@map("market_transactions")
}

// ============================================================================
// WORLD BUILDING v2 - TILE SYSTEM
// ============================================================================

model WorldTile {
  id            String   @id // Format: "z_x_y" (e.g., "14_4823_6127")
  z             Int // Zoom level
  x             Int // Tile X coordinate
  y             Int // Tile Y coordinate
  state         String   @default("COLD") // COLD, WARM, HOT
  lastTouchedAt DateTime @default(now())

  // Truth layer hashes (for cache invalidation)
  elevationHash   String?
  waterHash       String?
  populationHash  String?
  biomeHash       String?

  // Game layer versions (incremented when regenerated)
  ruinLayoutVersion Int @default(0)
  spawnTableVersion Int @default(0)
  navmeshVersion    Int @default(0)

  // Computed scores from truth layers
  ruinScore       Float @default(0) // 0-1, derived from population density
  damageScore     Float @default(0) // 0-1, how destroyed/collapsed
  corruptionScore Float @default(0) // 0-1, supernatural corruption level

  // Manifest hash (for client caching)
  manifestHash String?

  // Parent macro tile reference (for micro tiles at z=14)
  parentTileId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  buildJobs TileBuildJob[]

  @@unique([z, x, y])
  @@index([state])
  @@index([parentTileId])
  @@map("world_tiles")
}

model TileBuildJob {
  id          String    @id @default(uuid())
  tileId      String // Reference to WorldTile.id
  jobType     String // ELEVATION_FETCH, WATER_FETCH, POPULATION_FETCH, BIOME_FETCH, RUIN_GEN, SPAWN_GEN, NAV_BAKE
  status      String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED
  priority    Int       @default(0) // Higher = more urgent
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  errorMsg    String?
  outputHash  String? // Content-addressed hash of output
  inputHash   String? // Hash of inputs (for cache key)
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  tile WorldTile @relation(fields: [tileId], references: [id], onDelete: Cascade)

  @@index([status, priority])
  @@index([tileId])
  @@map("tile_build_jobs")
}
